<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#C67C4E">
    <title>Checkout - Bean & Brew</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/checkout.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <meta name="description" content="Complete your coffee order securely with Bean & Brew.">
</head>
<body>
    <!-- Animated Background Elements -->
    <div class="background-animation">
        <div class="coffee-bean bean-1"></div>
        <div class="coffee-bean bean-2"></div>
        <div class="coffee-bean bean-3"></div>
        <div class="coffee-bean bean-4"></div>
        <div class="coffee-bean bean-5"></div>
        <div class="steam steam-1"></div>
        <div class="steam steam-2"></div>
        <div class="steam steam-3"></div>
    </div>

    <%- include('../partials/navbar', { page: 'checkout' }) %>

    <main class="checkout-page">
        <div class="container">
            <!-- Header with Progress -->
            <header class="checkout-header">
                <h1><i class="fas fa-shopping-bag"></i> Secure Checkout</h1>
                <p class="checkout-subtitle">Complete your order in a few simple steps</p>
                
                <div class="progress-indicator">
                    <div class="progress-step completed">
                        <div class="step-icon"><i class="fas fa-cart-shopping"></i></div>
                        <span class="step-label">Cart</span>
                    </div>
                    <div class="progress-line completed"></div>
                    <div class="progress-step active">
                        <div class="step-icon"><i class="fas fa-credit-card"></i></div>
                        <span class="step-label">Checkout</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="progress-step">
                        <div class="step-icon"><i class="fas fa-circle-check"></i></div>
                        <span class="step-label">Complete</span>
                    </div>
                </div>
            </header>

            <div class="checkout-grid">
                <!-- Left: Form -->
                <section class="checkout-form">
                    <!-- Contact Information -->
                    <div class="form-section">
                        <div class="section-header">
                            <h2><i class="fas fa-user"></i> Contact Information</h2>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fullName">Full Name <span class="required">*</span></label>
                                <input type="text" id="fullName" placeholder="Juan Dela Cruz" required>
                            </div>
                        </div>
                        <div class="form-row two-col">
                            <div class="form-group">
                                <label for="email">Email <span class="required">*</span></label>
                                <input type="email" id="email" placeholder="juan@example.com" required>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone Number <span class="required">*</span></label>
                                <input type="tel" id="phone" placeholder="+63 912 345 6789" required>
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Address -->
                    <div class="form-section">
                        <div class="section-header">
                            <h2><i class="fas fa-truck"></i> Delivery Address</h2>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="address">Street Address <span class="required">*</span></label>
                                <input type="text" id="address" placeholder="123 Coffee Street" required>
                            </div>
                        </div>
                        <div class="form-row two-col">
                            <div class="form-group">
                                <label for="city">City <span class="required">*</span></label>
                                <input type="text" id="city" placeholder="Manila" required>
                            </div>
                            <div class="form-group">
                                <label for="zip">ZIP Code <span class="required">*</span></label>
                                <input type="text" id="zip" placeholder="1000" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="notes">Delivery Notes (Optional)</label>
                                <textarea id="notes" rows="3" placeholder="e.g. Please ring the doorbell twice"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="form-section">
                        <div class="section-header">
                            <h2><i class="fas fa-credit-card"></i> Payment Method</h2>
                        </div>
                        
                        <div class="payment-methods">
                            <label class="payment-option">
                                <input type="radio" name="payment" value="card" checked>
                                <div class="payment-card">
                                    <i class="fas fa-credit-card"></i>
                                    <span>Credit / Debit Card</span>
                                </div>
                            </label>
                            <label class="payment-option">
                                <input type="radio" name="payment" value="gcash">
                                <div class="payment-card">
                                    <i class="fas fa-mobile-screen"></i>
                                    <span>GCash</span>
                                </div>
                            </label>
                            <label class="payment-option">
                                <input type="radio" name="payment" value="cod">
                                <div class="payment-card">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <span>Cash on Delivery</span>
                                </div>
                            </label>
                        </div>

                        <!-- Card Details (shown when card is selected) -->
                        <div id="cardDetails" class="card-details">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="cardNumber">Card Number <span class="required">*</span></label>
                                    <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                                </div>
                            </div>
                            <div class="form-row two-col">
                                <div class="form-group">
                                    <label for="expiry">Expiry Date <span class="required">*</span></label>
                                    <input type="text" id="expiry" placeholder="MM/YY" maxlength="5">
                                </div>
                                <div class="form-group">
                                    <label for="cvv">CVV <span class="required">*</span></label>
                                    <input type="text" id="cvv" placeholder="123" maxlength="3">
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Right: Order Summary -->
                <aside class="order-summary-sticky">
                    <div class="order-summary checkout-card">
                        <h2><i class="fas fa-receipt"></i> Order Summary</h2>
                        
                        <div class="order-items" id="orderItems">
                            <!-- Items will be loaded from cart -->
                        </div>

                        <div class="order-totals">
                            <div class="total-row"><span>Subtotal</span><span id="checkoutSubtotal">‚Ç±0.00</span></div>
                            <div class="total-row"><span>Shipping</span><span id="checkoutShipping">‚Ç±59.00</span></div>
                            <div class="total-row"><span>Tax (8%)</span><span id="checkoutTax">‚Ç±0.00</span></div>
                            <div class="total-row discount-row" id="checkoutDiscountRow" style="display:none">
                                <span>Discount</span><span id="checkoutDiscount">‚Äì‚Ç±0.00</span>
                            </div>
                        </div>

                        <div class="total-main">
                            <span>Total</span>
                            <span id="checkoutTotal">‚Ç±0.00</span>
                        </div>

                        <button class="place-order-btn" id="placeOrderBtn">
                            <i class="fas fa-lock"></i> Place Order Securely
                        </button>

                        <div class="security-badges">
                            <div class="badge-item"><i class="fas fa-shield-halved"></i> Secure Payment</div>
                            <div class="badge-item"><i class="fas fa-rotate-left"></i> Easy Returns</div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </main>

    <!-- Back to Top Button -->
    <button class="back-to-top" id="backToTop" onclick="scrollToTop()" aria-label="Back to top">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 19V5M5 12L12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav" aria-label="Bottom Navigation">
        <a href="/" class="bn-link" aria-label="Home">
            <i class="fas fa-house" aria-hidden="true"></i>
            <span>Home</span>
        </a>
        <a href="/menu" class="bn-link" aria-label="Menu">
            <i class="fas fa-mug-saucer" aria-hidden="true"></i>
            <span>Menu</span>
        </a>
        <a href="/dashboard" class="bn-link" aria-label="Dashboard">
            <i class="fas fa-gauge" aria-hidden="true"></i>
            <span>Dashboard</span>
        </a>
        <a href="/cart" class="bn-link" aria-label="Cart">
            <i class="fas fa-cart-shopping" aria-hidden="true"></i>
            <span>Cart</span>
        </a>
        <a href="/specialties" class="bn-link" aria-label="Specialties">
            <i class="fas fa-star" aria-hidden="true"></i>
            <span>Specialties</span>
        </a>
    </nav>

    <script src="../js/shared.js"></script>
    <script>
        // Checkout page logic
        (function() {
            const CART_KEY = 'bb_cart_items';
            const PROMO_KEY = 'bb_cart_promo';
            const BASE_SHIPPING = 59.00;
            const TAX_RATE = 0.08;

            const orderItemsEl = document.getElementById('orderItems');
            const subtotalEl = document.getElementById('checkoutSubtotal');
            const shippingEl = document.getElementById('checkoutShipping');
            const taxEl = document.getElementById('checkoutTax');
            const totalEl = document.getElementById('checkoutTotal');
            const discountRowEl = document.getElementById('checkoutDiscountRow');
            const discountEl = document.getElementById('checkoutDiscount');
            const placeOrderBtn = document.getElementById('placeOrderBtn');
            const cardDetailsEl = document.getElementById('cardDetails');

            // Load cart data
            function loadCart() {
                try {
                    const data = JSON.parse(localStorage.getItem(CART_KEY));
                    return Array.isArray(data) ? data.filter(i => i.selected) : [];
                } catch { return []; }
            }

            function loadPromo() {
                try { return JSON.parse(localStorage.getItem(PROMO_KEY)) || { code: '', type: null, value: 0 }; }
                catch { return { code: '', type: null, value: 0 }; }
            }

            // Render order items
            function renderOrderSummary() {
                const items = loadCart();
                const promo = loadPromo();

                if (!items.length) {
                    orderItemsEl.innerHTML = `
                        <div class="empty-order">
                            <p>No items in your order.</p>
                            <a href="/cart" class="btn-link">‚Üê Back to Cart</a>
                        </div>
                    `;
                    return;
                }

                orderItemsEl.innerHTML = items.map(it => `
                    <div class="order-item">
                        <div class="oi-thumb">
                            ${it.img && (it.img.includes('/') || it.img.endsWith('.webp')) 
                                ? `<img src="${it.img}" alt="${it.name}">`
                                : it.img || '‚òï'}
                        </div>
                        <div class="oi-info">
                            <div class="oi-name">${it.name}</div>
                            <div class="oi-qty">Qty: ${it.qty}</div>
                        </div>
                        <div class="oi-price">‚Ç±${(it.price * it.qty).toFixed(2)}</div>
                    </div>
                `).join('');

                // Calculate totals
                const subtotal = items.reduce((s, i) => s + i.price * i.qty, 0);
                const shippingCost = promo.type === 'ship' ? 0 : BASE_SHIPPING;
                const tax = subtotal * TAX_RATE;
                let discount = 0;
                if (promo.type === 'percent') {
                    discount = subtotal * promo.value;
                }
                const total = Math.max(0, subtotal - discount) + tax + shippingCost;

                subtotalEl.textContent = `‚Ç±${subtotal.toFixed(2)}`;
                shippingEl.textContent = `‚Ç±${shippingCost.toFixed(2)}`;
                taxEl.textContent = `‚Ç±${tax.toFixed(2)}`;
                totalEl.textContent = `‚Ç±${total.toFixed(2)}`;

                if (discount > 0) {
                    discountRowEl.style.display = '';
                    discountEl.textContent = `‚Äì‚Ç±${discount.toFixed(2)}`;
                } else {
                    discountRowEl.style.display = 'none';
                }
            }

            // Payment method toggle
            document.querySelectorAll('input[name="payment"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'card') {
                        cardDetailsEl.style.display = 'block';
                    } else {
                        cardDetailsEl.style.display = 'none';
                    }
                });
            });

            // Form validation and submission
            placeOrderBtn.addEventListener('click', (e) => {
                e.preventDefault();
                
                const fullName = document.getElementById('fullName').value.trim();
                const email = document.getElementById('email').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const address = document.getElementById('address').value.trim();
                const city = document.getElementById('city').value.trim();
                const zip = document.getElementById('zip').value.trim();
                const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

                if (!fullName || !email || !phone || !address || !city || !zip) {
                    alert('Please fill in all required fields.');
                    return;
                }

                if (paymentMethod === 'card') {
                    const cardNumber = document.getElementById('cardNumber').value.trim();
                    const expiry = document.getElementById('expiry').value.trim();
                    const cvv = document.getElementById('cvv').value.trim();
                    if (!cardNumber || !expiry || !cvv) {
                        alert('Please complete your card details.');
                        return;
                    }
                }

                // Simulate order placement
                placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                placeOrderBtn.disabled = true;

                setTimeout(() => {
                    // Clear cart and promo
                    localStorage.removeItem(CART_KEY);
                    localStorage.removeItem(PROMO_KEY);
                    
                    alert('üéâ Order placed successfully! Thank you for choosing Bean & Brew.');
                    window.location.href = '/';
                }, 2000);
            });

            // Initialize
            renderOrderSummary();
        })();
    </script>
</body>
</html>
