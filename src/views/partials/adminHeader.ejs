<!-- Admin Header Partial -->
    <link rel="stylesheet" href="/css/adminHeaderSidebar.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

<header class="header">
    <button id="sidebarToggle" class="sidebar-toggle" aria-label="Toggle sidebar">
        <i class="fas fa-bars"></i>
    </button>
    <div class="header-actions">
        <!-- Notifications -->
        <div class="notification-dropdown">
            <button class="notification-btn" id="adminNotificationBtn" title="Notifications">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="adminNotificationBadgeMain">0</span>
            </button>

            <div class="notification-dropdown-menu" id="adminNotificationDropdown">
                <div class="notification-header">
                    <h4>Notifications</h4>
                    <button class="mark-all-read-btn" id="adminMarkAllReadBtn">Mark all read</button>
                </div>
                <div class="notification-list" id="adminNotificationList">
                    <!-- Notifications will be loaded here -->
                    <div class="notification-empty">
                        <i class="fas fa-bell-slash"></i>
                        <p>No notifications yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile dropdown (replaces standalone logout button) -->
        <div class="profile-dropdown" style="position: relative;">
            <button id="profileBtn" class="profile-btn" aria-haspopup="true" aria-expanded="false" style="display:flex;align-items:center;gap:8px;background:none;border:none;cursor:pointer;touch-action:manipulation;">
                <div class="user-avatar"><%= (admin && admin.email) ? admin.email.charAt(0).toUpperCase() : 'A' %></div>
                <div class="user-info">
                    <span class="user-name"><%= admin?.email || 'Admin' %></span>
                </div>
                <i class="fas fa-chevron-down user-dropdown-icon"></i>
            </button>

            <div id="profileMenu" class="profile-menu" style="position:absolute;right:0;top:calc(100% + 8px);background:white;border:1px solid #eee;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);display:none;min-width:160px;z-index:2000;">
                <a href="#" id="adminLogout" style="display:block;padding:10px 14px;color:#333;text-decoration:none;border-bottom:1px solid #f5f5f5;">Logout</a>
            </div>
        </div>
    </div>

    <script>
    (function(){
        const profileBtn = document.getElementById('profileBtn');
        const profileMenu = document.getElementById('profileMenu');
        const adminLogout = document.getElementById('adminLogout');
        const adminNotificationBtn = document.getElementById('adminNotificationBtn');
        const adminNotificationDropdown = document.getElementById('adminNotificationDropdown');

        function closeProfileMenu() {
            if (profileMenu) {
                profileMenu.style.display = 'none';
            }
            if (profileBtn) {
                profileBtn.setAttribute('aria-expanded', 'false');
            }
        }

        function closeNotificationDropdown() {
            if (adminNotificationDropdown) {
                adminNotificationDropdown.classList.remove('active');
            }
        }

        if (profileBtn && profileMenu) {
            profileBtn.addEventListener('click', function(e){
                e.preventDefault();
                e.stopPropagation();
                const isOpen = profileMenu.style.display === 'block';
                profileMenu.style.display = isOpen ? 'none' : 'block';
                profileBtn.setAttribute('aria-expanded', String(!isOpen));
                // Close notification dropdown if open
                closeNotificationDropdown();
            });

            // Consolidated click handler - close profile menu when clicking outside OR sidebar toggle
            document.addEventListener('click', function(ev){
                const sidebarToggle = document.getElementById('sidebarToggle');
                
                // Check if clicked sidebar toggle
                if (sidebarToggle && sidebarToggle.contains(ev.target)) {
                    closeProfileMenu();
                    closeNotificationDropdown();
                    return;
                }
                
                // Check if clicked outside profile menu
                if (!profileBtn.contains(ev.target) && !profileMenu.contains(ev.target)) {
                    closeProfileMenu();
                }

                // Check if clicked outside notification dropdown
                if (adminNotificationDropdown && !adminNotificationBtn.contains(ev.target) && !adminNotificationDropdown.contains(ev.target)) {
                    closeNotificationDropdown();
                }
            });

            // Close profile menu when a modal opens
            document.addEventListener('show.bs.modal', closeProfileMenu);
        }

        // Notification dropdown toggle
        if (adminNotificationBtn && adminNotificationDropdown) {
            adminNotificationBtn.addEventListener('click', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                const isActive = adminNotificationDropdown.classList.toggle('active');
                // Close profile menu if open
                closeProfileMenu();

                // Load notifications when opening dropdown
                if (isActive) {
                    await loadAdminNotifications();
                }
            });
        }

        // Load admin notifications
        async function loadAdminNotifications() {
            try {
                const response = await fetch('/admin/api/notifications');
                if (response.ok) {
                    const data = await response.json();
                    const notificationList = document.getElementById('adminNotificationList');
                    if (notificationList) {
                        if (data.items && data.items.length > 0) {
                            const notificationsHtml = data.items.map(notification => `
                                <div class="notification-item ${notification.is_read ? 'read' : 'unread'}" data-id="${notification.id}" onclick="markAdminNotificationRead(${notification.id})">
                                    <div class="notification-content">
                                        <div class="notification-title">${notification.title}</div>
                                        <div class="notification-message">${notification.message}</div>
                                        <div class="notification-time">${new Date(notification.created_at).toLocaleDateString()}</div>
                                    </div>
                                    ${!notification.is_read ? '<div class="notification-unread-dot"></div>' : ''}
                                </div>
                            `).join('');
                            notificationList.innerHTML = notificationsHtml;
                        } else {
                            notificationList.innerHTML = `
                                <div class="notification-empty">
                                    <i class="fas fa-bell-slash"></i>
                                    <p>No notifications yet</p>
                                </div>
                            `;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading admin notifications:', error);
            }
        }

        // Mark individual admin notification as read
        async function markAdminNotificationRead(notificationId) {
            try {
                const response = await fetch(`/admin/api/notifications/${notificationId}/read`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    // Refresh notifications and badge
                    await loadAdminNotifications();
                    await updateAdminNotificationBadge();
                }
            } catch (error) {
                console.error('Error marking admin notification as read:', error);
            }
        }

        // Update notification badge
        async function updateAdminNotificationBadge() {
            try {
                const response = await fetch('/admin/api/notifications/count');
                if (response.ok) {
                    const data = await response.json();
                    const badge = document.getElementById('adminNotificationBadgeMain');
                    if (badge) {
                        badge.textContent = data.count || 0;
                        badge.style.display = data.count > 0 ? 'flex' : 'none';
                    }
                }
            } catch (error) {
                console.error('Error updating admin notification badge:', error);
            }
        }

        // Update badge on page load and periodically
        updateAdminNotificationBadge();
        setInterval(updateAdminNotificationBadge, 30000);

        // Mark all admin notifications as read
        const adminMarkAllReadBtn = document.getElementById('adminMarkAllReadBtn');
        if (adminMarkAllReadBtn) {
            adminMarkAllReadBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch('/admin/api/notifications/mark-all-read', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    if (response.ok) {
                        // Refresh notifications and badge
                        await loadAdminNotifications();
                        await updateAdminNotificationBadge();
                    }
                } catch (error) {
                    console.error('Error marking admin notifications as read:', error);
                }
            });
        }

        if (adminLogout) {
            adminLogout.addEventListener('click', async function(e){
                e.preventDefault();
                try {
                    // POST to admin logout route to clear httpOnly cookie
                    const resp = await fetch('/admin/logout', { method: 'POST', credentials: 'same-origin' });
                    // Redirect to home after logout
                    window.location.href = '/';
                } catch (err) {
                    console.error('Admin logout failed', err);
                    window.location.href = '/';
                }
            });
        }
    })();
// Mark individual admin notification as read
async function markAdminNotificationRead(notificationId) {
    try {
        const response = await fetch(`/admin/api/notifications/${notificationId}/read`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        if (response.ok) {
            // Refresh notifications and badge
            await loadAdminNotifications();
            await updateAdminNotificationBadge();
        }
    } catch (error) {
        console.error('Error marking admin notification as read:', error);
    }
}
    </script>
    <script src="/js/admin/adminHeader.js"></script>
</header>
