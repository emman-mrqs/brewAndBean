<!-- Load Modern Navbar Styles -->
<link rel="stylesheet" href="/css/modernNavbar.css">

<!-- Modern Responsive Navigation -->
<nav class="navbar" id="navbar">
    <div class="navbar-container">
        <!-- Hamburger Menu (Mobile Only) -->
        <button class="hamburger-menu" id="navToggle" aria-label="Toggle Menu">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
        </button>

        <!-- Logo -->
        <a href="/" class="navbar-logo">
            <i class="fas fa-mug-hot logo-icon"></i>
            <span class="logo-text">Bean & Brew</span>
        </a>

        <!-- Desktop Navigation Links -->
        <ul class="desktop-nav-links">
            <li><a href="/" class="nav-link <%= page === 'home' ? 'active' : '' %>">Home</a></li>
            <li><a href="/menu" class="nav-link <%= page === 'menu' ? 'active' : '' %>">Menu</a></li>
            <li><a href="/specialties" class="nav-link <%= page === 'specialties' ? 'active' : '' %>">Specialties</a></li>
            <li><a href="/about" class="nav-link <%= page === 'about' ? 'active' : '' %>">About</a></li>
            <li><a href="/reviews" class="nav-link <%= page === 'reviews' ? 'active' : '' %>">Reviews</a></li>
            <li><a href="/contact" class="nav-link <%= page === 'contact' ? 'active' : '' %>">Contact</a></li>
            <li><a href="/download" class="nav-link <%= page === 'download' ? 'active' : '' %>">Download</a></li>
        </ul>

        <!-- Desktop User Actions -->
        <div class="navbar-actions">
            <!-- Cart -->
            <a href="/cart" class="action-btn cart-btn" title="Cart">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-badge" id="desktopCartBadge">0</span>
            </a>

            <!-- Notifications -->
            <div class="notification-dropdown">
                <button class="action-btn notification-btn" id="desktopNotificationBtn" title="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="desktopNotificationBadgeMain" style="display: none;">0</span>
                </button>

                <div class="notification-dropdown-menu" id="desktopNotificationDropdown">
                    <div class="notification-header">
                        <h4>Notifications</h4>
                        <button class="mark-all-read-btn" id="markAllReadBtn">Mark all read</button>
                    </div>
                    <div class="notification-list" id="notificationList">
                        <!-- Notifications will be loaded here -->
                        <div class="notification-empty">
                            <i class="fas fa-bell-slash"></i>
                            <p>No notifications yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Menu -->
            <% if (isAuthenticated && user) { %>
                <div class="user-dropdown">
                    <button class="user-btn" id="desktopUserBtn">
                        <div class="user-avatar">
                            <% const firstInitial = (user.firstName && typeof user.firstName === 'string') ? user.firstName.charAt(0) : (user.first_name && typeof user.first_name === 'string' ? user.first_name.charAt(0) : ''); %>
                            <% const lastInitial = (user.lastName && typeof user.lastName === 'string') ? user.lastName.charAt(0) : (user.last_name && typeof user.last_name === 'string' ? user.last_name.charAt(0) : ''); %>
                            <%= (firstInitial || lastInitial) ? (firstInitial + lastInitial).toUpperCase() : 'BB' %>
                            <span class="notification-badge" id="desktopNotificationBadge" style="display: none;">0</span>
                        </div>
                        <i class="fas fa-chevron-down dropdown-icon"></i>
                    </button>
                    
                    <div class="user-dropdown-menu" id="desktopUserDropdown">
                        <div class="dropdown-header">
                            <div class="user-info">
                                <p class="user-name"><%= user.firstName %> <%= user.lastName %></p>
                                <p class="user-email"><%= user.email %></p>
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a href="/dashboard" class="dropdown-item">
                            <i class="fas fa-home"></i>
                            <span>Dashboard</span>
                        </a>
                        <a href="/settings" class="dropdown-item">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                        <a href="/order-history" class="dropdown-item">
                            <i class="fas fa-history"></i>
                            <span>Order History</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <button type="button" class="dropdown-item logout-item btn-logout" data-logout>
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </button>

                    </div>
                </div>
            <% } else { %>
                <a href="/login" class="action-btn login-btn">
                    <i class="fas fa-user"></i>
                    <span class="login-text">Login</span>
                </a>
            <% } %>
        </div>
    </div>
</nav>

<!-- Modern Mobile Sidebar -->
<div class="mobile-sidebar" id="mobileSidebar">
    <div class="sidebar-content">
        <!-- Sidebar Header with User Info -->
        <div class="sidebar-header">
            <% if (isAuthenticated && user) { %>
                <div class="sidebar-user">
                    <div class="sidebar-user-avatar">
                        <% const sidebarFirstInitial = (user.firstName && typeof user.firstName === 'string') ? user.firstName.charAt(0) : (user.first_name && typeof user.first_name === 'string' ? user.first_name.charAt(0) : ''); %>
                        <% const sidebarLastInitial = (user.lastName && typeof user.lastName === 'string') ? user.lastName.charAt(0) : (user.last_name && typeof user.last_name === 'string' ? user.last_name.charAt(0) : ''); %>
                        <%= (sidebarFirstInitial || sidebarLastInitial) ? (sidebarFirstInitial + sidebarLastInitial).toUpperCase() : 'BB' %>
                        <span class="mobile-notification-badge" id="mobileNotificationBadge" style="display: none;">0</span>
                    </div>
                    <div class="sidebar-user-info">
                        <h3 class="sidebar-user-name"><%= user.firstName %> <%= user.lastName %></h3>
                        <p class="sidebar-user-email"><%= user.email %></p>
                    </div>
                </div>
            <% } else { %>
                <div class="sidebar-guest">
                    <div class="sidebar-guest-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="sidebar-guest-info">
                        <h3 class="sidebar-guest-title">Welcome, Guest</h3>
                        <a href="/login" class="sidebar-login-btn">Sign In</a>
                    </div>
                </div>
            <% } %>
        </div>

        <!-- Sidebar Navigation -->
        <nav class="sidebar-nav">
            <a href="/" class="sidebar-nav-item <%= page === 'home' ? 'active' : '' %>">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="/menu" class="sidebar-nav-item <%= page === 'menu' ? 'active' : '' %>">
                <i class="fas fa-coffee"></i>
                <span>Menu</span>
            </a>
            <a href="/specialties" class="sidebar-nav-item <%= page === 'specialties' ? 'active' : '' %>">
                <i class="fas fa-star"></i>
                <span>Specialties</span>
            </a>
            <a href="/about" class="sidebar-nav-item <%= page === 'about' ? 'active' : '' %>">
                <i class="fas fa-info-circle"></i>
                <span>About</span>
            </a>
            <a href="/reviews" class="sidebar-nav-item <%= page === 'reviews' ? 'active' : '' %>">
                <i class="fas fa-comments"></i>
                <span>Reviews</span>
            </a>
            <a href="/contact" class="sidebar-nav-item <%= page === 'contact' ? 'active' : '' %>">
                <i class="fas fa-envelope"></i>
                <span>Contact</span>
            </a>
            <a href="/download" class="sidebar-nav-item <%= page === 'download' ? 'active' : '' %>">
                <i class="fas fa-download"></i>
                <span>Download</span>
            </a>
        </nav>

        <!-- Sidebar Footer (For Authenticated Users) -->
        <% if (isAuthenticated && user) { %>
            <div class="sidebar-footer">
                <a href="/cart" class="sidebar-footer-item">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Cart</span>
                    <span class="sidebar-cart-badge" id="mobileCartBadge">0</span>
                </a>
                <button class="sidebar-footer-item notification-btn-mobile" id="mobileNotificationBtn">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                    <span class="sidebar-notification-badge" id="mobileNotificationBadgeMain" style="display: none;">0</span>
                </button>
                <a href="/dashboard" class="sidebar-footer-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/settings" class="sidebar-footer-item">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
                <button type="button" class="sidebar-footer-item logout btn-logout" data-logout>
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>

            </div>
        <% } else { %>
            <div class="sidebar-footer">
                <a href="/cart" class="sidebar-footer-item">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Cart</span>
                    <span class="sidebar-cart-badge" id="mobileCartBadge">0</span>
                </a>
                <button class="sidebar-footer-item notification-btn-mobile" id="mobileNotificationBtn">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                    <span class="sidebar-notification-badge" id="mobileNotificationBadgeMain" style="display: none;">0</span>
                </button>
            </div>
        <% } %>
    </div>
</div>

<!-- Mobile Notification Dropdown -->
<div class="mobile-notification-dropdown" id="mobileNotificationDropdown">
    <div class="mobile-notification-header">
        <h4>Notifications</h4>
        <button class="mobile-mark-all-read-btn" id="mobileMarkAllReadBtn">Mark all read</button>
    </div>
    <div class="mobile-notification-list" id="mobileNotificationList">
        <!-- Notifications will be loaded here -->
        <div class="notification-empty">
            <i class="fas fa-bell-slash"></i>
            <p>No notifications yet</p>
        </div>
    </div>
    <div class="mobile-notification-footer">
        <a href="/notifications" class="mobile-view-all-link">View All Notifications</a>
    </div>
</div>

<!-- Backdrop -->
<div class="sidebar-backdrop" id="sidebarBackdrop"></div>

<script>
(function () {
  'use strict';

  // Cached DOM elements
  const navbar = document.getElementById('navbar');
  const backToTop = document.getElementById('backToTop');
  const navToggle = document.getElementById('navToggle');
  const mobileSidebar = document.getElementById('mobileSidebar');
  const sidebarBackdrop = document.getElementById('sidebarBackdrop');
  const desktopUserBtn = document.getElementById('desktopUserBtn');
  const desktopUserDropdown = document.getElementById('desktopUserDropdown');
  const desktopNotificationBtn = document.getElementById('desktopNotificationBtn');
  const desktopNotificationDropdown = document.getElementById('desktopNotificationDropdown');
  const mobileNotificationBtn = document.getElementById('mobileNotificationBtn');
  const mobileNotificationDropdown = document.getElementById('mobileNotificationDropdown');
  const markAllReadBtn = document.getElementById('markAllReadBtn');
  const mobileMarkAllReadBtn = document.getElementById('mobileMarkAllReadBtn');

  // --- Helpers for badges ---
  const badgeIds = [
    'desktopNotificationBadgeMain',
    'mobileNotificationBadgeMain',
    'bottomNotificationBadgeMain'
  ];

  function setBadges(count) {
    console.log('Setting notification badge count to:', count);
    const num = Number(count) || 0;
    
    badgeIds.forEach(id => {
      const el = document.getElementById(id);
      if (!el) {
        console.log('Badge element not found:', id);
        return;
      }
      console.log('Updating badge', id, 'to count:', num);
      el.textContent = String(num);
      el.style.display = num > 0 ? 'flex' : 'none';
    });
  }

  // Navbar scroll effect
  let scrollTimeout;
  window.addEventListener('scroll', () => {
    if (!scrollTimeout) {
      scrollTimeout = setTimeout(() => {
        const scrolled = window.scrollY > 50;
        navbar?.classList.toggle('scrolled', scrolled);
        backToTop?.classList.toggle('visible', scrolled);
        scrollTimeout = null;
      }, 100);
    }
  }, { passive: true });

  // Mobile sidebar toggle
  if (navToggle && mobileSidebar) {
    const toggleSidebar = () => {
      const isActive = mobileSidebar.classList.toggle('active');
      navToggle.classList.toggle('active', isActive);
      sidebarBackdrop?.classList.toggle('active', isActive);
      document.body.style.overflow = isActive ? 'hidden' : '';
    };
    navToggle.addEventListener('click', toggleSidebar);
    sidebarBackdrop?.addEventListener('click', toggleSidebar);
    mobileSidebar.querySelectorAll('.sidebar-nav-item, .sidebar-footer-item').forEach(link => {
      link.addEventListener('click', () => {
        if (!link.classList.contains('logout')) toggleSidebar();
      });
    });
  }

  // Desktop user dropdown toggle
  if (desktopUserBtn && desktopUserDropdown) {
    desktopUserBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      desktopUserDropdown.classList.toggle('active');
      desktopNotificationDropdown?.classList.remove('active');
    });
    document.addEventListener('click', (e) => {
      if (!desktopUserBtn.contains(e.target) && !desktopUserDropdown.contains(e.target)) {
        desktopUserDropdown.classList.remove('active');
      }
    });
  }

  // Desktop notification dropdown toggle
  if (desktopNotificationBtn && desktopNotificationDropdown) {
    desktopNotificationBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const isActive = desktopNotificationDropdown.classList.toggle('active');
      desktopUserDropdown?.classList.remove('active');
      if (isActive) await loadUserNotifications();
    });
    document.addEventListener('click', (e) => {
      if (!desktopNotificationBtn.contains(e.target) && !desktopNotificationDropdown.contains(e.target)) {
        desktopNotificationDropdown.classList.remove('active');
      }
    });
  }

  // Mobile notification dropdown toggle
  if (mobileNotificationBtn && mobileNotificationDropdown) {
    mobileNotificationBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const isActive = mobileNotificationDropdown.classList.toggle('active');
      // Close sidebar if open
      mobileSidebar?.classList.remove('active');
      navToggle?.classList.remove('active');
      sidebarBackdrop?.classList.remove('active');
      document.body.style.overflow = '';
      if (isActive) await loadUserNotifications();
    });
    document.addEventListener('click', (e) => {
      if (!mobileNotificationBtn.contains(e.target) && !mobileNotificationDropdown.contains(e.target)) {
        mobileNotificationDropdown.classList.remove('active');
      }
    });
  }

  // --- Cart badge ---
  async function updateCartBadge() {
    try {
      const res = await fetch('/api/cart/count', { credentials: 'same-origin' });
      if (!res.ok) return;
      const data = await res.json();
      const mobileCartBadge = document.getElementById('mobileCartBadge');
      const desktopCartBadge = document.getElementById('desktopCartBadge');
      if (mobileCartBadge) {
        mobileCartBadge.textContent = data.count || 0;
        mobileCartBadge.style.display = data.count > 0 ? 'flex' : 'none';
      }
      if (desktopCartBadge) {
        desktopCartBadge.textContent = data.count || 0;
        desktopCartBadge.style.display = data.count > 0 ? 'flex' : 'none';
      }
    } catch (err) {
      console.error('updateCartBadge error', err);
    }
  }

  // --- Notifications list & badge ---
  async function loadUserNotifications() {
    try {
      const res = await fetch('/api/notifications', { credentials: 'same-origin' });
      if (!res.ok) return;
      const data = await res.json();
      const desktopList = document.getElementById('notificationList');
      const mobileList = document.getElementById('mobileNotificationList');

      const render = (container) => {
        if (!container) return;
        if (!data.items || data.items.length === 0) {
          container.innerHTML = `
            <div class="notification-empty">
              <i class="fas fa-bell-slash"></i>
              <p>No notifications yet</p>
            </div>`;
          return;
        }

        container.innerHTML = data.items.map(n => `
          <div class="notification-item ${n.is_read ? 'read' : 'unread'}" data-id="${n.id}" onclick="markNotificationRead(${n.id})">
            <div class="notification-content">
              <div class="notification-title">${escapeHtml(n.title)}</div>
              <div class="notification-message">${escapeHtml(n.message)}</div>
              <div class="notification-time">${new Date(n.created_at).toLocaleDateString()}</div>
            </div>
            ${!n.is_read ? '<div class="notification-unread-dot"></div>' : ''}
          </div>
        `).join('');
      };

      render(desktopList);
      render(mobileList);
    } catch (err) {
      console.error('loadUserNotifications error', err);
    }
  }

  async function updateNotificationBadge() {
    try {
      console.log('Fetching notification count...');
      const res = await fetch('/api/notifications/count', { credentials: 'same-origin' });
      if (!res.ok) {
        console.error('Failed to fetch notification count:', res.status);
        return;
      }
      const responseText = await res.text();
      let json;
      try {
        json = JSON.parse(responseText);
      } catch (e) {
        console.error('Response is not JSON:', responseText);
        return;
      }
      console.log('Notification count response:', json);
      setBadges(Number(json.count) || 0);
    } catch (err) {
      console.error('updateNotificationBadge error', err);
    }
  }

  // Mark all read (uses server-canonical count returned)
  async function markAllRead() {
    try {
      // optimistic hide while request is in-flight
      setBadges(0);

      const res = await fetch('/api/notifications/mark-all-read', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin'
      });

      if (!res.ok) {
        console.error('mark-all-read failed', res.status);
        // re-sync
        await updateNotificationBadge();
        await loadUserNotifications();
        return;
      }

      const json = await res.json();
      setBadges(Number(json.count) || 0);
      await loadUserNotifications();
      window.dispatchEvent(new Event('notificationUpdated'));
    } catch (err) {
      console.error('markAllRead error', err);
      await updateNotificationBadge();
    }
  }

  // Mark single notification read (uses server-canonical count returned)
  async function markNotificationRead(id) {
    try {
      if (!id) return;
      const res = await fetch(`/api/notifications/${id}/read`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin'
      });
      if (!res.ok) {
        console.error('markNotificationRead failed', res.status);
        await updateNotificationBadge();
        await loadUserNotifications();
        return;
      }
      const json = await res.json();
      setBadges(Number(json.count) || 0);
      await loadUserNotifications();
      window.dispatchEvent(new Event('notificationUpdated'));
    } catch (err) {
      console.error('markNotificationRead error', err);
      await updateNotificationBadge();
    }
  }

  // global for inline onclick in markup
  window.markNotificationRead = markNotificationRead;

  // --- small helper ---
  function escapeHtml(str = '') {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  // Wire up Mark All buttons
  markAllReadBtn?.addEventListener('click', markAllRead);
  mobileMarkAllReadBtn?.addEventListener('click', markAllRead);

// Initial load + polling
updateCartBadge();
if (document.getElementById('desktopNotificationBadgeMain')) {
  updateNotificationBadge();
  setInterval(updateNotificationBadge, 30000);
}
setInterval(updateCartBadge, 30000);  // allow external triggers
  window.addEventListener('cartUpdated', updateCartBadge);
  window.addEventListener('notificationUpdated', updateNotificationBadge);

  // Handle bottom notification button (may load after navbar)
  function initBottomNotificationBtn() {
    const bottomNotificationBtn = document.getElementById('bottomNotificationBtn');
    if (bottomNotificationBtn && mobileNotificationDropdown) {
      bottomNotificationBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const isActive = mobileNotificationDropdown.classList.toggle('active');
        // Close sidebar if open
        mobileSidebar?.classList.remove('active');
        navToggle?.classList.remove('active');
        sidebarBackdrop?.classList.remove('active');
        document.body.style.overflow = '';
        if (isActive) await loadUserNotifications();
      });
      document.addEventListener('click', (e) => {
        if (!bottomNotificationBtn.contains(e.target) && !mobileNotificationDropdown.contains(e.target)) {
          mobileNotificationDropdown.classList.remove('active');
        }
      });
    }
  }

  // Check for bottom notification button immediately and after DOM loads
  initBottomNotificationBtn();
  document.addEventListener('DOMContentLoaded', initBottomNotificationBtn);
})();

// Logout function
function logout() {
    // Create and submit a POST form to /logout to end the session
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/logout';

    // Include CSRF token if present
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    if (csrfToken) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = '_csrf';
        input.value = csrfToken;
        form.appendChild(input);
    }

    form.style.display = 'none';
    document.body.appendChild(form);
    form.submit();
}

// Make function global
window.logout = logout;
window.confirmLogout = logout; // alias for older inline calls

// Use event delegation for logout buttons
document.addEventListener('click', (e) => {
    const el = e.target.closest('[data-logout], .btn-logout');
    if (!el) return;
    e.preventDefault();
    logout();
});

</script>


